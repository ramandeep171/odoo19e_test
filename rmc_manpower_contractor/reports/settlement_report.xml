<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <data>
        <report
            id="action_rmc_agreement_settlement_report"
            string="Agreement Settlement"
            model="rmc.agreement.settlement.wizard"
            report_type="qweb-pdf"
            name="rmc_manpower_contractor.report_agreement_settlement"
            file="rmc_manpower_contractor.report_agreement_settlement"
            print_report_name="'Settlement - %s' % (object.agreement_id.name,)"/>

        <template id="report_agreement_settlement">
            <t t-foreach="docs" t-as="doc">
                <t t-call="web.external_layout">
                    <div class="page settlement-report">
                        <div class="row">
                            <div class="col-12">
                                <h2 class="text-center">Agreement Settlement Packet</h2>
                            </div>
                        </div>
                        <div class="row mt16">
                            <div class="col-6">
                                <p>
                                    <strong>Agreement:</strong>
                                    <span t-esc="doc.agreement_id.display_name"/>
                                </p>
                                <p>
                                    <strong>Contractor:</strong>
                                    <span t-esc="doc.contractor_id.display_name"/>
                                </p>
                            </div>
                            <div class="col-6">
                                <p>
                                    <strong>Period:</strong>
                                    <span t-esc="doc.period_start"/> → <span t-esc="doc.period_end"/>
                                </p>
                                <p>
                                    <strong>Final State:</strong>
                                    <span t-esc="doc.agreement_id.state"/>
                                </p>
                            </div>
                        </div>
                        <h3 class="mt24">Performance &amp; MGQ</h3>
                        <table class="table table-sm o_main_table">
                            <tbody>
                                <tr>
                                    <th>MGQ Target (m³)</th>
                                    <td t-esc="doc.mgq_target"/>
                                    <th>Actual Production (m³)</th>
                                    <td t-esc="doc.mgq_actual_qty"/>
                                    <th>MGQ Achieved</th>
                                    <td>
                                        <span t-esc="doc.mgq_achieved and 'Yes' or 'No'"/>
                                    </td>
                                </tr>
                                <tr>
                                    <th>Part-A Fixed (Monthly)</th>
                                    <td t-esc="doc.agreement_id.part_a_fixed"/>
                                    <th>Part-B Target (Monthly)</th>
                                    <td t-esc="doc.agreement_id.part_b_variable"/>
                                    <th>Part-B Payout</th>
                                    <td t-esc="doc.variable_pay_amount"/>
                                </tr>
                            </tbody>
                        </table>
                        <h3 class="mt24">Financial Summary</h3>
                        <table class="table table-sm o_main_table">
                            <tbody>
                                <tr>
                                    <th>Variable Pay (Part-B)</th>
                                    <td t-esc="doc.variable_pay_amount"/>
                                    <th>Breakdown Deductions</th>
                                    <td t-esc="doc.breakdown_deduction_total"/>
                                </tr>
                                <tr>
                                    <th>Inventory Variance</th>
                                    <td t-esc="doc.inventory_variance_total"/>
                                    <th>Damage Charges</th>
                                    <td t-esc="doc.damage_cost_total"/>
                                </tr>
                                <tr>
                                    <th>Open Vendor Bills</th>
                                    <td t-esc="doc.open_bills_total"/>
                                    <th>Final Payable / (Receivable)</th>
                                    <td t-esc="doc.final_payable_amount"/>
                                </tr>
                                <tr>
                                    <th>Proposed Action</th>
                                    <td t-esc="doc.proposed_action_label"/>
                                    <th>Notes</th>
                                    <td t-esc="doc.notes or '-'"/>
                                </tr>
                            </tbody>
                        </table>
                        <h3 class="mt24">Breakdown Events Included</h3>
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Reference</th>
                                    <th>Description</th>
                                    <th>Downtime (Hr)</th>
                                    <th>Deduction</th>
                                </tr>
                            </thead>
                            <tbody>
                                <t t-foreach="doc.breakdown_event_ids" t-as="event">
                                    <tr>
                                        <td t-esc="event.display_name"/>
                                        <td t-esc="event.name or event.description"/>
                                        <td t-esc="event.downtime_hr"/>
                                        <td t-esc="event.deduction_amount"/>
                                    </tr>
                                </t>
                                <tr t-if="not doc.breakdown_event_ids">
                                    <td colspan="4">No breakdown events included.</td>
                                </tr>
                            </tbody>
                        </table>
                        <h3 class="mt24">Final Inventory Hand-back</h3>
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Item</th>
                                    <th>Variance Qty</th>
                                    <th>Variance Value</th>
                                    <th>Damage Cost</th>
                                    <th>Acknowledged By</th>
                                    <th>Signature</th>
                                </tr>
                            </thead>
                            <tbody>
                                <t t-foreach="doc.inventory_handover_ids" t-as="handover">
                                    <tr>
                                        <td t-esc="handover.item_id.display_name"/>
                                        <td t-esc="handover.variance_qty"/>
                                        <td t-esc="handover.variance_value"/>
                                        <td t-esc="handover.damage_cost"/>
                                        <td t-esc="handover.acknowledged_by.display_name or '-'"/>
                                        <td>
                                            <img t-if="handover.ack_signature" t-att-src="'data:image/png;base64,%s' % (handover.ack_signature.decode() if isinstance(handover.ack_signature, bytes) else handover.ack_signature)" style="max-height:60px;"/>
                                            <span t-if="not handover.ack_signature">—</span>
                                        </td>
                                    </tr>
                                </t>
                                <tr t-if="not doc.inventory_handover_ids">
                                    <td colspan="6">No pending hand-back items.</td>
                                </tr>
                            </tbody>
                        </table>
                        <h3 class="mt24">Open Vendor Bills</h3>
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Bill</th>
                                    <th>Date</th>
                                    <th>Due Date</th>
                                    <th>Residual</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                <t t-foreach="doc.open_bill_ids" t-as="bill">
                                    <tr>
                                        <td t-esc="bill.display_name"/>
                                        <td t-esc="bill.invoice_date"/>
                                        <td t-esc="bill.invoice_date_due"/>
                                        <td t-esc="bill.amount_residual"/>
                                        <td t-esc="bill.payment_state"/>
                                    </tr>
                                </t>
                                <tr t-if="not doc.open_bill_ids">
                                    <td colspan="5">No pending bills.</td>
                                </tr>
                            </tbody>
                        </table>
                        <div class="mt24">
                            <p>
                                <strong>Settlement Prepared By:</strong>
                                <span t-esc="doc.create_uid.display_name if doc.create_uid else '-'"/>
                            </p>
                            <p>
                                <strong>Prepared On:</strong>
                                <span t-esc="doc.create_date"/>
                            </p>
                        </div>
                    </div>
                </t>
            </t>
        </template>
    </data>
</odoo>
